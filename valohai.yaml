---

- step:
    name: tensorflow-check
    image: tensorflow/tensorflow:1.13.1-gpu-py3
    command:
      - pip install keras==2.1.3
      - pwd
      - lsb_release -a
      - python --version
      - python -c "import keras; print(keras.__version__);"
      - python -c "import tensorflow; print(tensorflow.__version__);"
      - python -c "from tensorflow.python.client import device_lib; device_lib.list_local_devices();"
      - nvidia-smi
      - nvcc --version | grep release
      - cat /usr/include/x86_64-linux-gnu/cudnn_v*.h | grep CUDNN_MAJOR -A 2

- step:
    name: tensorflow-deep-dream
    image: tensorflow/tensorflow:1.13.1-gpu-py3
    command:
      - pip install keras==2.1.3 imageio==2.5.0
      - python deep_dream.py {parameters}
    inputs:
      - name: source-image
        default: https://valohai-examples.s3-eu-west-1.amazonaws.com/images/ribs_original.jpg
    parameters:
      - name: base_image_path
        pass-as: '{v}'
        type: string
        default: /valohai/inputs/source-image/ribs_original.jpg
        description: Path to the image to transform.
      - name: result_prefix
        pass-as: '{v}'
        type: string
        default: /valohai/outputs/result
        description: Prefix for the saved results.
      - name: iterations
        pass-as: '{v}'
        type: integer
        default: 5
        description: How many iterations to transform.
      - name: image_height
        pass-as: '{v}'
        type: integer
        default: 600
        description: Height of the resulting image.
      - name: image_width
        pass-as: '{v}'
        type: integer
        default: 600
        description: Width of the resulting image.
      - name: setting_name
        pass-as: '{v}'
        type: string
        default: dreamy
        description: Generation settings, 'bad_trip' or 'dreamy'.

- step:
    name: tensorflow-cifar
    image: tensorflow/tensorflow:1.13.1-gpu-py3
    command:
      - pip install keras==2.1.3
      - python cifar10_cnn.py {parameters}
    inputs:
      - name: cifar-10-batches-py
        default: http://www.cs.toronto.edu/~kriz/cifar-10-python.tar.gz
    parameters:
      - name: batch_size
        pass-as: --batch_size={v}
        type: integer
        default: 32
      - name: num_classes
        pass-as: --num_classes={v}
        type: integer
        default: 10
      - name: epochs
        pass-as: --epochs={v}
        type: integer
        default: 5
      - name: data_augmentation
        pass-as: --data_augmentation={v}
        type: string
        default: True
